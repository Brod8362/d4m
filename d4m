#!/usr/bin/env python3
import vdf
import os
import toml
from sys import platform
from divamod import DivaMod, UnmanageableModError
import colorama
from manage import ModManager, load_mods
from simple_term_menu import TerminalMenu
import api

MEGAMIX_APPID = 1761390
LIBRARYFOLDERS_VDF_PATH = os.path.expanduser("~/.local/share/Steam/config/libraryfolders.vdf")

if platform != "linux":
    print("this mod manager is only supported on linux")
    quit()

if not os.path.isfile(LIBRARYFOLDERS_VDF_PATH):
    print("cannot find libraryfolders.vdf")

MEGAMIX_PATH = None

with open(LIBRARYFOLDERS_VDF_PATH) as vdf_fd:
    data = vdf.parse(vdf_fd)
    for library_index in data["libraryfolders"]:
        library_folder = data["libraryfolders"][library_index]
        if str(MEGAMIX_APPID) in library_folder["apps"] and MEGAMIX_PATH == None:
            MEGAMIX_PATH = os.path.join(library_folder['path'], "steamapps/common/Hatsune Miku Project DIVA Mega Mix Plus/")

if MEGAMIX_PATH == None:
    print("couldn't find megamix install directory, is it installed?")
    quit()

if not os.path.isfile(os.path.join(MEGAMIX_PATH, "config.toml")):
    print("couldn't find config.toml in megamix root, is DivaModLoader installed?")
    quit()

with open(os.path.join(MEGAMIX_PATH, "config.toml")) as conf_fd:
    config = toml.load(conf_fd)
    ENABLED_MODS_PATH = MEGAMIX_PATH + config["mods"]
    DISABLED_MODS_PATH = MEGAMIX_PATH + config.get("disabled_mods", "disabled_mods")

for d in [ENABLED_MODS_PATH, DISABLED_MODS_PATH]:
    os.makedirs(d, exist_ok=True)

enabled_mods, unmanageable_mods = load_mods(ENABLED_MODS_PATH)
disabled_mods, unmanageable_mods_2 = load_mods(DISABLED_MODS_PATH)

def menu_install(mod_manager: ModManager):
    search_str = input("Search for a mod...:")
    found_mods = api.search_mods(search_str)
    if len(found_mods) == 0:
        print("No mods found.")
    else:
        options = [f"Cancel"]
        options.extend(map(lambda x: x[1].strip().replace("\n", ""), found_mods))
        mod_search_menu = TerminalMenu(options)
        choice = mod_search_menu.show()
        if 0 < choice < len(options):
            mod = found_mods[choice-1]
            print(f"Installing {mod[1]} ({mod[0]})")
            mod_manager.install_mod(mod[0])
            print(f"{colorama.Fore.GREEN}Installed {mod[1]}{colorama.Fore.RESET}")

def menu_manage():
    pass

options = ["Install new mods", "Manage existing mods", "Exit"]
print("d4m v0.0")
manageable: "list[DivaMod]" = len(enabled_mods) + len(disabled_mods)
unmanageable: "list[str]" = len(unmanageable_mods) + len(unmanageable_mods_2)
print(f"{manageable+unmanageable} installed")

mod_manager = ModManager(ENABLED_MODS_PATH, None, None, None, None)
while True:
    root_menu = TerminalMenu(options)
    sel = root_menu.show()
    if sel == 0: #install new
        menu_install(mod_manager)
    elif sel == 1: #manage existing
        pass
    else:
        break